<!-- templates/advertisements/ad_detail.html -->
{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ ad.title }} | Autoplaza{% endblock %}

{% block meta %}
<meta name="description" content="{{ ad.description|truncatechars:150 }}">
<meta property="og:title" content="{{ ad.title }}">
<meta property="og:description" content="{{ ad.description|truncatechars:150 }}">
{% if ad.get_main_photo %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ ad.get_main_photo.image.url }}">
{% endif %}
<meta property="og:url" content="{{ request.build_absolute_uri }}">
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Хлебные крошки -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'core:home' %}">Главная</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'advertisements:ad_list' %}">Объявления</a>
            </li>
            {% if ad.model.brand %}
            <li class="breadcrumb-item">
                <a href="{% url 'cars:brand_detail' ad.model.brand.slug %}">{{ ad.model.brand.name }}</a>
            </li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">{{ ad.title|truncatechars:30 }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Левая колонка: фото и описание -->
        <div class="col-lg-8">
            <!-- Заголовок и цена -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h1 class="h2 mb-2">{{ ad.title }}</h1>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-2">{{ ad.get_owner_type_display }}</span>
                        <span class="text-muted">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            {{ ad.city }}, {{ ad.region }}
                        </span>
                    </div>
                </div>
                <div class="text-end">
                    <div class="display-6 text-primary mb-1">{{ ad.price|intcomma }} ₽</div>
                    {% if ad.is_negotiable %}
                    <span class="badge bg-warning">Торг уместен</span>
                    {% endif %}
                </div>
            </div>

            <!-- Галерея фотографий -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-3">
                    {% if ad.photos.all %}
                        <div class="main-photo mb-3">
                            {% with ad.photos.all|first as main_photo %}
                            <img src="{{ main_photo.image.url }}"
                                 alt="{{ ad.title }}"
                                 class="img-fluid rounded"
                                 id="main-photo">
                            {% endwith %}
                        </div>

                        {% if ad.photos.count > 1 %}
                        <div class="photo-thumbnails">
                            <div class="row g-2">
                                {% for photo in ad.photos.all %}
                                <div class="col-3 col-sm-2">
                                    <img src="{{ photo.thumbnail.url|default:photo.image.url }}"
                                         alt="{{ ad.title }}"
                                         class="img-thumbnail photo-thumbnail {% if forloop.first %}active{% endif %}"
                                         data-full="{{ photo.image.url }}"
                                         onclick="changeMainPhoto('{{ photo.image.url }}', this)">
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5 bg-light rounded">
                            <i class="fas fa-car fa-5x text-muted mb-3"></i>
                            <p class="text-muted">Нет фотографий</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Описание -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h3 class="h5 mb-0">Описание</h3>
                </div>
                <div class="card-body">
                    <div class="description-content">
                        {{ ad.description|linebreaks }}
                    </div>
                </div>
            </div>

            <!-- Характеристики -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h3 class="h5 mb-0">Характеристики</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <th width="40%">Марка/Модель:</th>
                                        <td>
                                            {% if ad.model.brand %}
                                            <a href="{% url 'cars:brand_detail' ad.model.brand.slug %}">
                                                {{ ad.model.brand.name }}
                                            </a>
                                            {% endif %}
                                            {{ ad.model.name }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Год выпуска:</th>
                                        <td>{{ ad.year }} г.</td>
                                    </tr>
                                    <tr>
                                        <th>Пробег:</th>
                                        <td>{{ ad.mileage|intcomma }} км</td>
                                    </tr>
                                    <tr>
                                        <th>Тип кузова:</th>
                                        <td>{{ ad.model.body_type|default:"Не указано" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Цвет:</th>
                                        <td>{{ ad.color|default:"Не указано" }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <th width="40%">Тип топлива:</th>
                                        <td>{{ ad.get_fuel_type_display|default:"Не указано" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Коробка передач:</th>
                                        <td>{{ ad.get_transmission_display|default:"Не указано" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Привод:</th>
                                        <td>{{ ad.get_drive_type_display|default:"Не указано" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Объем двигателя:</th>
                                        <td>
                                            {% if ad.engine_volume %}
                                                {{ ad.engine_volume }} л
                                            {% else %}
                                                Не указано
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Мощность:</th>
                                        <td>
                                            {% if ad.engine_power %}
                                                {{ ad.engine_power }} л.с.
                                            {% else %}
                                                Не указано
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- VIN -->
                    {% if ad.vin %}
                    <div class="mt-4 pt-3 border-top">
                        <strong>VIN:</strong> <code>{{ ad.vin }}</code>
                    </div>
                    {% endif %}

                    <!-- Дополнительные опции -->
                    {% if ad.features.all %}
                    <div class="mt-4 pt-3 border-top">
                        <h6 class="mb-3">Дополнительные опции</h6>
                        <div class="row">
                            {% for feature in ad.features.all %}
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" checked disabled>
                                    <label class="form-check-label">
                                        {{ feature.name }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Правая колонка: контакты и действия -->
        <div class="col-lg-4">
            <!-- Карточка продавца -->
            <div class="card border-0 shadow-sm mb-4 sticky-top" style="top: 20px;">
                <div class="card-body">
                    <h4 class="h5 card-title mb-3">Контакты продавца</h4>

                    <!-- Информация о продавце -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="seller-avatar me-3">
                                {% if ad.owner.avatar %}
                                    <img src="{{ ad.owner.avatar.url }}"
                                         alt="{{ ad.owner.get_full_name }}"
                                         class="rounded-circle"
                                         style="width: 50px; height: 50px; object-fit: cover;">
                                {% else %}
                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                                         style="width: 50px; height: 50px;">
                                        {{ ad.owner.get_full_name|slice:":1"|upper }}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <h6 class="mb-0">{{ ad.owner.get_full_name|default:ad.owner.username }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-user me-1"></i>
                                    {{ ad.get_owner_type_display }}
                                </small>
                            </div>
                        </div>

                        {% if ad.owner_type == 'dealer' and ad.owner.dealer_profile %}
                        <div class="dealer-info border-top pt-3">
                            <h6 class="mb-2">{{ ad.owner.dealer_profile.company_name }}</h6>
                            <small class="text-muted">
                                <i class="fas fa-star text-warning"></i>
                                Рейтинг: {{ ad.owner.dealer_profile.rating|default:"-" }}
                            </small>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Контактные кнопки -->
                    <div class="d-grid gap-2 mb-3">
                        {% if ad.owner.phone %}
                        <button class="btn btn-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#phoneModal">
                            <i class="fas fa-phone-alt me-2"></i>Показать телефон
                        </button>
                        {% endif %}

                        <button class="btn btn-outline-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#messageModal">
                            <i class="fas fa-envelope me-2"></i>Написать сообщение
                        </button>

                        {% if user.is_authenticated %}
                        <button class="btn btn-outline-danger"
                                onclick="toggleFavorite({{ ad.id }})"
                                id="favorite-btn">
                            <i class="fas fa-heart" id="favorite-icon"></i>
                            <span id="favorite-text">
                                {% if is_favorite %}Удалить из избранного{% else %}В избранное{% endif %}
                            </span>
                        </button>
                        {% endif %}
                    </div>

                    <!-- Статистика -->
                    <div class="border-top pt-3">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="stat-item">
                                    <div class="text-muted small">Просмотры</div>
                                    <div class="h6 mb-0">{{ ad.views|default:0 }}</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-item">
                                    <div class="text-muted small">Опубликовано</div>
                                    <div class="h6 mb-0">{{ ad.created_at|date:"d.m.Y" }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ID объявления -->
                    <div class="border-top pt-3 mt-3">
                        <small class="text-muted">ID: {{ ad.id }}</small>
                    </div>
                </div>
            </div>

            <!-- Быстрые действия -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="h6 mb-3">Быстрые действия</h5>
                    <div class="d-grid gap-2">
                        <a href="{% url 'advertisements:ad_list' %}?brand={{ ad.model.brand.slug }}"
                           class="btn btn-outline-secondary">
                            <i class="fas fa-search me-2"></i>Искать {{ ad.model.brand.name }}
                        </a>

                        {% if user.is_authenticated and user == ad.owner %}
                        <a href="{% url 'advertisements:ad_edit' ad.slug %}" class="btn btn-outline-primary">
                            <i class="fas fa-edit me-2"></i>Редактировать
                        </a>

                        <button class="btn btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteModal">
                            <i class="fas fa-trash me-2"></i>Удалить
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Похожие объявления -->
    {% if similar_ads %}
    <div class="mt-5">
        <h3 class="h4 mb-4">Похожие объявления</h3>
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
            {% for similar_ad in similar_ads|slice:":4" %}
            <div class="col">
                {% include 'advertisements/partials/ad_card.html' with ad=similar_ad %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Модальные окна -->

<!-- Телефон -->
<div class="modal fade" id="phoneModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Контактный телефон</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                {% if ad.owner.phone %}
                <h3 class="display-6 mb-4">{{ ad.owner.phone }}</h3>
                <p class="text-muted">Позвоните продавцу для уточнения деталей</p>
                {% else %}
                <p class="text-muted">Телефон не указан</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Сообщение -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Написать сообщение</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'advertisements:send_ad_message' ad.id %}">
                {% csrf_token %}
                <input type="hidden" name="ad_id" value="{{ ad.id }}">
                <div class="modal-body">
                    {% if not user.is_authenticated %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Чтобы отправить сообщение, <a href="{% url 'users:login' %}">войдите</a> или
                        <a href="{% url 'users:register' %}">зарегистрируйтесь</a>.
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <label class="form-label">Ваше имя</label>
                        <input type="text" class="form-control" name="name"
                               value="{{ user.get_full_name|default:user.username }}"
                               {% if user.is_authenticated %}readonly{% endif %} required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ваш телефон</label>
                        <input type="tel" class="form-control" name="phone"
                               value="{{ user.phone|default:'' }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Сообщение</label>
                        <textarea class="form-control" name="message" rows="4" required>
Здравствуйте! Заинтересовался вашим объявлением "{{ ad.title }}".
Можете рассказать подробнее?
                        </textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary"
                            {% if not user.is_authenticated %}disabled{% endif %}>
                        Отправить
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Удаление (для владельца) -->
{% if user.is_authenticated and user == ad.owner %}
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Удаление объявления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить объявление <strong>"{{ ad.title }}"</strong>?</p>
                <p class="text-danger"><small>Это действие нельзя отменить.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <form method="post" action="{% url 'advertisements:ad_delete' ad.slug %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Удалить</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Смена главной фотографии
function changeMainPhoto(photoUrl, element) {
    const mainPhoto = document.getElementById('main-photo');
    if (mainPhoto) {
        mainPhoto.src = photoUrl;

        // Удаляем активный класс у всех миниатюр
        document.querySelectorAll('.photo-thumbnail').forEach(thumb => {
            thumb.classList.remove('active');
        });

        // Добавляем активный класс к текущей миниатюре
        element.classList.add('active');
    }
}

// Добавление/удаление из избранного
function toggleFavorite(adId) {
    if (!{% if user.is_authenticated %}true{% else %}false{% endif %}) {
        window.location.href = "{% url 'users:login' %}?next={{ request.path }}";
        return;
    }

    const btn = document.getElementById('favorite-btn');
    const icon = document.getElementById('favorite-icon');
    const text = document.getElementById('favorite-text');

    // ИСПРАВЛЕННЫЙ URL: используем advertisements namespace вместо api
    fetch(`/advertisements/${adId}/favorite/toggle/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'added') {
            icon.className = 'fas fa-heart text-danger';
            text.textContent = 'Удалить из избранного';
            btn.classList.add('active');

            // Показываем уведомление
            showNotification('Добавлено в избранное', 'success');
        } else if (data.status === 'removed') {
            icon.className = 'fas fa-heart';
            text.textContent = 'В избранное';
            btn.classList.remove('active');

            // Показываем уведомление
            showNotification('Удалено из избранного', 'info');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Ошибка. Попробуйте еще раз', 'error');
    });
}

// Всплывающее уведомление
function showNotification(message, type = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'info': 'alert-info',
        'warning': 'alert-warning'
    }[type] || 'alert-info';

    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alert);

    // Автоматически скрыть через 5 секунд
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// Сохранение истории просмотров
document.addEventListener('DOMContentLoaded', function() {
    // Отмечаем объявление как просмотренное
    if ({% if user.is_authenticated %}true{% else %}false{% endif %}) {
        // ИСПРАВЛЕННЫЙ URL: используем advertisements namespace вместо api
        fetch(`/advertisements/${ {{ ad.id }} }/view/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
    }
});
</script>
{% endblock %}