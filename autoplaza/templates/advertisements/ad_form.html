<!-- templates/advertisements/ad_form.html -->
{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Редактирование{% else %}Создание{% endif %} объявления | Autoplaza
{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css' rel='stylesheet' />
<style>
.select2-container--default .select2-selection--single {
    height: 38px;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}
.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 36px;
}
.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Стили для множественного выбора файлов */
#photos-clear_id {
    display: none !important;
}

.custom-file-input {
    position: relative;
    overflow: hidden;
    display: inline-block;
    cursor: pointer;
}

/* Прогресс бар для загрузки фото */
.progress {
    height: 6px;
    margin-top: 5px;
}

.progress-bar {
    transition: width 0.3s ease;
}

/* Стили для отображения только имени модели в выпадающем списке */
#id_model option {
    padding-left: 8px;
}

/* Анимации для индикатора загрузки и ошибок */
#model-loading {
    transition: opacity 0.3s ease;
}

#model-loading.show {
    display: block !important;
}

.alert.model-load-error {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Стиль для информации о модели */
#model-info {
    font-size: 0.875rem;
}
#model-info strong {
    color: #0d6efd;
}

/* Стиль для новых фотографий */
.badge.bg-primary {
    background-color: #0d6efd !important;
}
</style>
{% endblock %}

{% block content %}
<div class='container py-4'>
    <div class='row justify-content-center'>
        <div class='col-lg-10'>
            <!-- Хлебные крошки -->
            <nav aria-label='breadcrumb' class='mb-4'>
                <ol class='breadcrumb'>
                    <li class='breadcrumb-item'><a href='{% url "core:home" %}'>Главная</a></li>
                    <li class='breadcrumb-item'><a href='{% url "advertisements:ad_list" %}'>Объявления</a></li>
                    {% if form.instance.pk %}
                    <li class='breadcrumb-item'><a href='{% url "advertisements:my_ads" %}'>Мои объявления</a></li>
                    {% endif %}
                    <li class='breadcrumb-item active'>
                        {% if form.instance.pk %}Редактирование{% else %}Создание{% endif %} объявления
                    </li>
                </ol>
            </nav>

            <!-- Заголовок -->
            <div class='d-flex justify-content-between align-items-center mb-4'>
                <h1 class='h3 mb-0'>
                    {% if form.instance.pk %}
                    <i class='fas fa-edit me-2'></i>Редактирование объявления
                    {% else %}
                    <i class='fas fa-plus-circle me-2'></i>Создание объявления
                    {% endif %}
                </h1>

                {% if form.instance.pk %}
                <a href='{% url "advertisements:ad_detail" form.instance.slug %}' class='btn btn-outline-primary btn-sm'>
                    <i class='fas fa-eye me-1'></i>Просмотр
                </a>
                {% endif %}
            </div>

            <!-- Форма -->
            <div class='card border-0 shadow-sm'>
                <div class='card-body p-4'>
                    <!-- Скрытый элемент для передачи API URL в JavaScript -->
                    <div id="api-urls"
                         data-models-api-url="{% url 'advertisements:api_models' %}"
                         style="display: none;">
                    </div>

                    <form method='post' enctype='multipart/form-data' id='ad-form'>
                        {% csrf_token %}
                        <!-- DEBUG: Form structure -->
                        <div class="alert alert-info mb-3">
                            <h6>Form Structure Debug</h6>
                            <p>Total form fields: {{ form.fields|length }}</p>
                            <p>Form field names:
                                {% for field in form %}
                                    {{ field.name }}
                                {% endfor %}
                            </p>
                            <p>Has 'brand' field:
                                {% if 'brand' in form.fields %}
                                    Да
                                {% else %}
                                    Нет
                                {% endif %}
                            </p>
                            <p>Has 'model' field:
                                {% if 'model' in form.fields %}
                                    Да
                                {% else %}
                                    Нет
                                {% endif %}
                            </p>
                        </div>

                        <!-- Марка и модель с динамической загрузкой -->
                        <div class='row mb-4'>
                            <div class='col-md-6'>
                                <div class='form-group'>
                                    <label for='id_brand' class='form-label'>Марка автомобиля *</label>
                                    <select name='brand' id='id_brand' class='form-select' required>
                                        <option value=''>Выберите марку</option>
                                        {% for brand in brands %}
                                        <option value='{{ brand.id }}' {% if form.brand.value and form.brand.value.id == brand.id %}selected{% elif form.instance.model and form.instance.model.brand.id == brand.id %}selected{% endif %}>
                                            {{ brand.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if form.brand.errors %}
                                    <div class="text-danger small">{{ form.brand.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class='col-md-6'>
                                <div class='form-group'>
                                    <label for='id_model' class='form-label'>Модель автомобиля *</label>
                                    <div id='model-select-container'>
                                        <select name='model' id='id_model' class='form-select' required {% if not form.model.value and not form.instance.model %}disabled{% endif %}>
                                            <option value=''>{% if form.model.value or form.instance.model %}Выберите модель{% else %}Сначала выберите марку{% endif %}</option>
                                            {% if form.instance.model %}
                                            <option value='{{ form.instance.model.id }}' selected>
                                                {{ form.instance.model.name }}
                                            </option>
                                            {% endif %}
                                        </select>
                                        <div id='model-loading' class='mt-2' style='display: none;'>
                                            <span class='loading me-2'></span>
                                            <small class='text-muted'>Загрузка моделей...</small>
                                        </div>
                                    </div>
                                    {% if form.model.errors %}
                                    <div class="text-danger small">{{ form.model.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Основные поля -->
                        <div class='row mb-4'>
                            <div class='col-md-12'>
                                {{ form.price|as_crispy_field }}
                            </div>
                        </div>

                        <div class='row mb-4'>
                            <div class='col-md-3'>
                                {{ form.year|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.mileage|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.mileage_unit|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.is_negotiable|as_crispy_field }}
                            </div>
                        </div>

                        <!-- Двигатель и трансмиссия -->
                        <div class='row mb-4'>
                            <div class='col-md-3'>
                                {{ form.engine_volume|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.engine_power|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.fuel_type|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.transmission_type|as_crispy_field }}
                            </div>
                        </div>

                        <div class='row mb-4'>
                            <div class='col-md-3'>
                                {{ form.drive_type|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.condition|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.steering_wheel|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.doors|as_crispy_field }}
                            </div>
                        </div>

                        <!-- Цвет и локация -->
                        <div class='row mb-4'>
                            <div class='col-md-4'>
                                {{ form.color_exterior|as_crispy_field }}
                            </div>
                            <div class='col-md-4'>
                                {{ form.color_interior|as_crispy_field }}
                            </div>
                            <div class='col-md-4'>
                                {{ form.seats|as_crispy_field }}
                            </div>
                        </div>

                        <div class='row mb-4'>
                            <div class='col-md-6'>
                                {{ form.city|as_crispy_field }}
                            </div>
                            <div class='col-md-6'>
                                {{ form.region|as_crispy_field }}
                            </div>
                        </div>

                        <!-- VIN и дополнительные опции -->
                        <div class='row mb-4'>
                            <div class='col-md-6'>
                                {{ form.vin|as_crispy_field }}
                            </div>
                            <div class='col-md-6'>
                                <div class='d-flex align-items-center h-100'>
                                    <div class='form-check form-switch me-3'>
                                        {{ form.has_tuning|as_crispy_field }}
                                    </div>
                                    <div class='form-check form-switch'>
                                        {{ form.service_history|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Фотографии -->
                        <div class='mb-4'>
                            <h5 class='mb-3'><i class='fas fa-camera me-2'></i>Фотографии</h5>
                            <div class='alert alert-info'>
                                <small>
                                    <i class='fas fa-info-circle me-1'></i>
                                    Загрузите фотографии автомобиля. Первое фото будет главным.
                                    Поддерживаются JPG, PNG, WEBP до 10MB.
                                </small>
                            </div>


                            <!-- Предпросмотр загруженных фото -->
                            {% if form.instance.pk and form.instance.photos.all %}
                            <div class='mt-3'>
                                <h6 class='mb-2'>Загруженные фотографии:</h6>
                                <div class='row g-2' id='uploaded-photos'>
                                    {% for photo in form.instance.photos.all %}
                                    <div class='col-3 col-md-2'>
                                        <div class='position-relative'>
                                            <img src='{{ photo.thumbnail.url|default:photo.image.url }}'
                                                 alt='Фото {{ forloop.counter }}'
                                                 class='img-thumbnail w-100'
                                                 style='height: 80px; object-fit: cover;'>
                                            {% if photo.is_main %}
                                            <span class='badge bg-success position-absolute top-0 start-0 m-1'>Главное</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Описание -->
                        <div class='mb-4'>
                            {{ form.description|as_crispy_field }}
                        </div>

                        <!-- Кнопки -->
                        <div class='mt-4'>
                            <div class='d-flex justify-content-between'>
                                <a href='{% url "advertisements:my_ads" %}' class='btn btn-outline-secondary'>
                                    Отмена
                                </a>
                                <div>
                                    <button type='submit' name='save_draft' value='true' class='btn btn-outline-primary me-2'>
                                        Сохранить черновик
                                    </button>
                                    <button type='submit' name='publish' value='true' class='btn btn-primary'>
                                        {% if form.instance.pk %}
                                        <i class='fas fa-save me-2'></i>Сохранить изменения
                                        {% else %}
                                        <i class='fas fa-paper-plane me-2'></i>Опубликовать
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- ДЕБАГ информация -->
                        <div class="alert alert-warning mt-3">
                            <h6><i class="fas fa-bug"></i> Debug Info</h6>
                            <p>Brand value: <span id="debug-brand"></span></p>
                            <p>Model value: <span id="debug-model"></span></p>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="testApi()">
                                Test API
                            </button>
                        </div>

                        <script>
                        function testApi() {
                            const brandId = document.getElementById('id_brand').value;
                            const url = '/advertisements/models-api/?brand_id=' + brandId;
                            console.log('Testing API:', url);

                            fetch(url)
                                .then(r => r.json())
                                .then(data => {
                                    console.log('API Result:', data);
                                    alert('API работает! Получено ' + data.length + ' моделей');
                                })
                                .catch(err => {
                                    console.error('API Error:', err);
                                    alert('API ошибка: ' + err.message);
                                });
                        }

                        // Обновляем debug info
                        setInterval(() => {
                            document.getElementById('debug-brand').textContent =
                                document.getElementById('id_brand').value;
                            document.getElementById('debug-model').textContent =
                                document.getElementById('id_model').value;
                        }, 1000);
                        </script>
                    </form>
                </div>
            </div>

            <!-- Подсказки -->
            <div class='mt-4'>
                <div class='alert alert-light'>
                    <h6 class='alert-heading'><i class='fas fa-lightbulb me-2'></i>Советы:</h6>
                    <ul class='mb-0'>
                        <li>Заполняйте все поля максимально подробно</li>
                        <li>Добавьте качественные фотографии с разных ракурсов</li>
                        <li>Укажите реальный пробег и состояние автомобиля</li>
                        <li>Укажите свой контактный телефон в профиле</li>
                        <li>Черновик можно сохранить и опубликовать позже</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Сначала загружаем jQuery, потом Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/ru.js'></script>
<script>
(function() {
    'use strict';

    console.log('=== AUTOPLAZA FORM INIT (DEBUG VERSION) ===');

    // Функция для безопасной инициализации
    function initializeForm() {
        console.log('Initializing form...');

        // ВАЖНО: Найдем элементы ПО-ДРУГОМУ
        // Сначала попробуем найти по name, потом по id
        let brandSelect = document.querySelector('select[name="brand"]');
        if (!brandSelect) {
            brandSelect = document.getElementById('id_brand');
            console.log('Brand by name not found, trying by id:', !!brandSelect);
        }

        let modelSelect = document.querySelector('select[name="model"]');
        if (!modelSelect) {
            modelSelect = document.getElementById('id_model');
            console.log('Model by name not found, trying by id:', !!modelSelect);
        }

        console.log('Elements found:', {
            brand: !!brandSelect,
            model: !!modelSelect,
            brandId: brandSelect ? brandSelect.id : 'none',
            brandName: brandSelect ? brandSelect.name : 'none',
            modelId: modelSelect ? modelSelect.id : 'none',
            modelName: modelSelect ? modelSelect.name : 'none'
        });

        // Если нет элементов, попробуем найти их по другим способам
        if (!brandSelect || !modelSelect) {
            console.error('Form elements not found! Searching alternatives...');

            // Ищем вручную - проверим все select
            const allSelects = document.querySelectorAll('select');
            console.log(`Total selects on page: ${allSelects.length}`);

            allSelects.forEach((sel, idx) => {
                console.log(`Select ${idx}: id="${sel.id}", name="${sel.name}", innerHTML length: ${sel.innerHTML.length}`);

                // Если этот select содержит бренды
                if (sel.innerHTML.includes('Toyota') || sel.innerHTML.includes('BMW') || sel.innerHTML.includes('Mercedes')) {
                    console.log('  ^ This looks like a brand select!');
                    if (!brandSelect) brandSelect = sel;
                }

                // Если этот select содержит "Выберите модель"
                if (sel.innerHTML.includes('Выберите модель') || sel.innerHTML.includes('Сначала выберите марку')) {
                    console.log('  ^ This looks like a model select!');
                    if (!modelSelect) modelSelect = sel;
                }
            });

            if (!brandSelect || !modelSelect) {
                console.error('STILL NOT FOUND! Cannot initialize form.');
                return;
            }
        }

        console.log('SUCCESS: Form elements identified!');

        // 1. Инициализация Select2
        try {
            $(brandSelect).select2({
                theme: 'bootstrap-5',
                width: '100%',
                language: 'ru'
            });

            $(modelSelect).select2({
                theme: 'bootstrap-5',
                width: '100%',
                language: 'ru',
                disabled: true
            });

            console.log('Select2 initialized');
        } catch (error) {
            console.error('Select2 initialization error:', error);
        }

        // 2. Функция загрузки моделей
        function loadModels(brandId) {
            console.log(`loadModels called with brandId: ${brandId}`);

            if (!brandId) {
                $(modelSelect).html('<option value="">Сначала выберите марку</option>');
                $(modelSelect).prop('disabled', true).trigger('change');
                return;
            }

            // Показываем загрузку
            $(modelSelect).prop('disabled', true);
            $(modelSelect).html('<option value="">Загрузка моделей...</option>');

            // API запрос
            const apiUrlsElement = document.getElementById('api-urls');
            const modelsApiUrl = apiUrlsElement ? apiUrlsElement.getAttribute('data-models-api-url') : '';
            const apiUrl = `${modelsApiUrl}?brand_id=${brandId}`;
            console.log(`Fetching from: ${apiUrl}`);
            console.log('Using API URL:', apiUrl);

            fetch(apiUrl)
                .then(response => {
                    console.log(`Response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`Received ${data.length} models`);

                    $(modelSelect).empty();
                    $(modelSelect).append('<option value="">Выберите модель</option>');

                    if (data.length === 0) {
                        $(modelSelect).append('<option value="" disabled>Нет доступных моделей</option>');
                        console.warn('No models returned from API');
                    } else {
                        data.forEach(model => {
                            const option = new Option(model.name, model.id);
                            if (model.year_start) $(option).data('year_start', model.year_start);
                            if (model.year_end) $(option).data('year_end', model.year_end);
                            if (model.body_type) $(option).data('body_type', model.body_type);
                            $(modelSelect).append(option);
                        });
                    }

                    $(modelSelect).prop('disabled', false).trigger('change');

                    // Если редактируем существующее объявление
                    {% if form.instance.model %}
                        const savedModelId = {{ form.instance.model.id|default:"null" }};
                        if (savedModelId && savedModelId !== "null") {
                            setTimeout(() => {
                                $(modelSelect).val(savedModelId).trigger('change');
                                console.log(`Set saved model ID: ${savedModelId}`);
                            }, 200);
                        }
                    {% endif %}
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    $(modelSelect).html('<option value="">Ошибка загрузки</option>');

                    // Показать ошибку
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger mt-2';
                    errorDiv.innerHTML = `
                        <strong>Ошибка загрузки!</strong> Не удалось загрузить список моделей.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;

                    const container = document.querySelector('.form-group:has(#id_model)') ||
                                      document.getElementById('model-select-container');
                    if (container) {
                        container.appendChild(errorDiv);
                    }
                });
        }

        // 3. Событие изменения марки
        $(brandSelect).on('change', function() {
            console.log(`Brand changed: ${this.value}`);
            loadModels(this.value);
        });

        // 4. Автозаполнение года
        $(modelSelect).on('change', function() {
            const selected = $(this).find('option:selected');
            const yearStart = selected.data('year_start');
            const yearField = document.querySelector('input[name="year"], #id_year');

            if (yearField && !yearField.value && yearStart) {
                yearField.value = yearStart;
                console.log(`Auto-filled year: ${yearStart}`);
            }
        });

        // 5. Если уже есть выбранная марка (при редактировании)
        {% if form.instance.model %}
            console.log('Editing mode detected');
            const initialBrandId = {{ form.instance.model.brand.id|default:"null" }};
            if (initialBrandId && initialBrandId !== "null") {
                console.log(`Initial brand ID: ${initialBrandId}`);

                // Устанавливаем значение через setTimeout чтобы Select2 успел инициализироваться
                setTimeout(() => {
                    $(brandSelect).val(initialBrandId).trigger('change');

                    // Загружаем модели через небольшую задержку
                    setTimeout(() => {
                        loadModels(initialBrandId);
                    }, 300);
                }, 100);
            }
        {% endif %}

        console.log('Form initialization COMPLETE');
    }

    // Запускаем инициализацию когда DOM готов
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeForm);
    } else {
        initializeForm();
    }
})();
</script>

<!-- ДЕБАГ СКРИПТ ДЛЯ РУЧНОЙ ПРОВЕРКИ -->
<script>
// Ручная проверка API
function testApiManually() {
    const brandId = prompt('Введите ID бренда для теста (например 16 для Toyota):', '16');
    if (!brandId) return;

    console.log(`Manual API test for brand ID: ${brandId}`);
    fetch(`/advertisements/models-api/?brand_id=${brandId}`)
        .then(r => {
            console.log(`Status: ${r.status} ${r.statusText}`);
            return r.json();
        })
        .then(data => {
            console.log('Response:', data);
            alert(`Получено ${data.length} моделей\nПервые 3: ${data.slice(0,3).map(m => m.name).join(', ')}`);
        })
        .catch(err => {
            console.error('Error:', err);
            alert(`Ошибка: ${err.message}`);
        });
}

// Проверка элементов на странице
function checkPageElements() {
    console.log('=== PAGE ELEMENT CHECK ===');

    // Проверим форму
    const form = document.querySelector('form#ad-form');
    console.log('Main form found:', !!form);

    if (form) {
        console.log('Form elements:');
        Array.from(form.elements).forEach((el, i) => {
            if (el.name || el.id) {
                console.log(`  [${i}] name="${el.name}", id="${el.id}", type="${el.type}", tag="${el.tagName}"`);
            }
        });
    }

    // Проверим, есть ли вообще поля для бренда и модели
    const hasBrandField = document.querySelector('[name*="brand"], [id*="brand"]');
    const hasModelField = document.querySelector('[name*="model"], [id*="model"]');

    console.log('Brand field exists:', !!hasBrandField);
    console.log('Model field exists:', !!hasModelField);

    if (!hasBrandField) {
        console.error('NO BRAND FIELD FOUND ON PAGE!');
        alert('ВНИМАНИЕ: Не найдено поле для выбора марки автомобиля!');
    }
}

// Автоматически проверим при загрузке
setTimeout(checkPageElements, 1000);

// Добавим кнопку для ручного теста в DOM
document.addEventListener('DOMContentLoaded', function() {
    // Добавим кнопку для тестирования
    const debugDiv = document.createElement('div');
    debugDiv.className = 'alert alert-secondary mt-3';
    debugDiv.innerHTML = `
        <h6><i class="fas fa-wrench"></i> Форма отладки</h6>
        <button onclick="testApiManually()" class="btn btn-sm btn-outline-primary me-2">
            Тест API вручную
        </button>
        <button onclick="checkPageElements()" class="btn btn-sm btn-outline-secondary">
            Проверить элементы
        </button>
        <small class="d-block mt-2" id="debug-status">Статус: Загрузка...</small>
    `;

    const formContainer = document.querySelector('.card-body');
    if (formContainer) {
        formContainer.appendChild(debugDiv);
    }

    // Обновляем статус
    setTimeout(() => {
        const statusEl = document.getElementById('debug-status');
        if (statusEl) {
            const brandFound = document.querySelector('[name*="brand"], [id*="brand"]');
            const modelFound = document.querySelector('[name*="model"], [id*="model"]');
            statusEl.textContent = `Статус: Бренд - ${brandFound ? 'найден' : 'НЕ НАЙДЕН'}, Модель - ${modelFound ? 'найден' : 'НЕ НАЙДЕН'}`;
        }
    }, 2000);
});
</script>
{% endblock %}