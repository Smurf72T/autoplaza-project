﻿<!-- templates/advertisements/ad_form.html -->
{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Редактирование{% else %}Создание{% endif %} объявления | Autoplaza
{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css' rel='stylesheet' />
<style>
.select2-container--default .select2-selection--single {
    height: 38px;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}
.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 36px;
}
.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Стили для множественного выбора файлов */
#photos-clear_id {
    display: none !important;
}

.custom-file-input {
    position: relative;
    overflow: hidden;
    display: inline-block;
    cursor: pointer;
}

/* Прогресс бар для загрузки фото */
.progress {
    height: 6px;
    margin-top: 5px;
}

.progress-bar {
    transition: width 0.3s ease;
}

/* Стили для отображения только имени модели в выпадающем списке */
#id_model option {
    padding-left: 8px;
}

/* Анимации для индикатора загрузки и ошибок */
#model-loading {
    transition: opacity 0.3s ease;
}

#model-loading.show {
    display: block !important;
}

.alert.model-load-error {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Стиль для информации о модели */
#model-info {
    font-size: 0.875rem;
}
#model-info strong {
    color: #0d6efd;
}

/* Стиль для новых фотографий */
.badge.bg-primary {
    background-color: #0d6efd !important;
}
</style>
{% endblock %}

{% block content %}
<div class='container py-4'>
    <div class='row justify-content-center'>
        <div class='col-lg-10'>
            <!-- Хлебные крошки -->
            <nav aria-label='breadcrumb' class='mb-4'>
                <ol class='breadcrumb'>
                    <li class='breadcrumb-item'><a href='{% url "core:home" %}'>Главная</a></li>
                    <li class='breadcrumb-item'><a href='{% url "advertisements:ad_list" %}'>Объявления</a></li>
                    {% if form.instance.pk %}
                    <li class='breadcrumb-item'><a href='{% url "advertisements:my_ads" %}'>Мои объявления</a></li>
                    {% endif %}
                    <li class='breadcrumb-item active'>
                        {% if form.instance.pk %}Редактирование{% else %}Создание{% endif %} объявления
                    </li>
                </ol>
            </nav>

            <!-- Заголовок -->
            <div class='d-flex justify-content-between align-items-center mb-4'>
                <h1 class='h3 mb-0'>
                    {% if form.instance.pk %}
                    <i class='fas fa-edit me-2'></i>Редактирование объявления
                    {% else %}
                    <i class='fas fa-plus-circle me-2'></i>Создание объявления
                    {% endif %}
                </h1>

                {% if form.instance.pk %}
                <a href='{% url "advertisements:ad_detail" form.instance.slug %}' class='btn btn-outline-primary btn-sm'>
                    <i class='fas fa-eye me-1'></i>Просмотр
                </a>
                {% endif %}
            </div>

            <!-- Форма -->
            <div class='card border-0 shadow-sm'>
                <div class='card-body p-4'>
                    <!-- Скрытый элемент для передачи API URL в JavaScript -->
                    <div id="api-urls"
                         data-models-api-url="{% url 'advertisements:api_models_by_brand' %}"
                         style="display: none;">
                    </div>

                    <form method='post' enctype='multipart/form-data' id='ad-form'>
                        {% csrf_token %}

                        <!-- Марка и модель с динамической загрузкой -->
                        <div class='row mb-4'>
                            <div class='col-md-6'>
                                <div class='form-group'>
                                    <label for='id_brand' class='form-label'>Марка автомобиля *</label>
                                    <select name='brand' id='id_brand' class='form-select' required>
                                        <option value=''>Выберите марку</option>
                                        {% for brand in brands %}
                                        <option value='{{ brand.id }}' {% if form.brand.value and form.brand.value.id == brand.id %}selected{% elif form.instance.model and form.instance.model.brand.id == brand.id %}selected{% endif %}>
                                            {{ brand.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if form.brand.errors %}
                                    <div class="text-danger small">{{ form.brand.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class='col-md-6'>
                                <div class='form-group'>
                                    <label for='id_model' class='form-label'>Модель автомобиля *</label>
                                    <div id='model-select-container'>
                                        <select name='model' id='id_model' class='form-select' required {% if not form.model.value and not form.instance.model %}disabled{% endif %}>
                                            <option value=''>{% if form.model.value or form.instance.model %}Выберите модель{% else %}Сначала выберите марку{% endif %}</option>
                                            {% if form.instance.model %}
                                            <option value='{{ form.instance.model.id }}' selected>
                                                {{ form.instance.model.name }}
                                            </option>
                                            {% endif %}
                                        </select>
                                        <div id='model-loading' class='mt-2' style='display: none;'>
                                            <span class='loading me-2'></span>
                                            <small class='text-muted'>Загрузка моделей...</small>
                                        </div>
                                    </div>
                                    {% if form.model.errors %}
                                    <div class="text-danger small">{{ form.model.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Основные поля -->
                        <div class='row mb-4'>
                            <div class='col-md-6'>
                                {{ form.title|as_crispy_field }}
                            </div>
                            <div class='col-md-6'>
                                {{ form.price|as_crispy_field }}
                            </div>
                        </div>

                        <div class='row mb-4'>
                            <div class='col-md-3'>
                                {{ form.year|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.mileage|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.mileage_unit|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.is_negotiable|as_crispy_field }}
                            </div>
                        </div>

                        <!-- Двигатель и трансмиссия -->
                        <div class='row mb-4'>
                            <div class='col-md-3'>
                                {{ form.engine_volume|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.engine_power|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.fuel_type|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.transmission_type|as_crispy_field }}
                            </div>
                        </div>

                        <div class='row mb-4'>
                            <div class='col-md-3'>
                                {{ form.drive_type|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.condition|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.steering_wheel|as_crispy_field }}
                            </div>
                            <div class='col-md-3'>
                                {{ form.doors|as_crispy_field }}
                            </div>
                        </div>

                        <!-- Цвет и локация -->
                        <div class='row mb-4'>
                            <div class='col-md-4'>
                                {{ form.color_exterior|as_crispy_field }}
                            </div>
                            <div class='col-md-4'>
                                {{ form.color_interior|as_crispy_field }}
                            </div>
                            <div class='col-md-4'>
                                {{ form.seats|as_crispy_field }}
                            </div>
                        </div>

                        <div class='row mb-4'>
                            <div class='col-md-6'>
                                {{ form.city|as_crispy_field }}
                            </div>
                            <div class='col-md-6'>
                                {{ form.region|as_crispy_field }}
                            </div>
                        </div>

                        <!-- VIN и дополнительные опции -->
                        <div class='row mb-4'>
                            <div class='col-md-6'>
                                {{ form.vin|as_crispy_field }}
                            </div>
                            <div class='col-md-6'>
                                <div class='d-flex align-items-center h-100'>
                                    <div class='form-check form-switch me-3'>
                                        {{ form.has_tuning|as_crispy_field }}
                                    </div>
                                    <div class='form-check form-switch'>
                                        {{ form.service_history|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Фотографии -->
                        <div class='mb-4'>
                            <h5 class='mb-3'><i class='fas fa-camera me-2'></i>Фотографии</h5>
                            <div class='alert alert-info'>
                                <small>
                                    <i class='fas fa-info-circle me-1'></i>
                                    Загрузите фотографии автомобиля. Первое фото будет главным.
                                    Поддерживаются JPG, PNG, WEBP до 10MB.
                                </small>
                            </div>

                            {{ form.photos|as_crispy_field }}

                            <!-- Предпросмотр загруженных фото -->
                            {% if form.instance.pk and form.instance.photos.all %}
                            <div class='mt-3'>
                                <h6 class='mb-2'>Загруженные фотографии:</h6>
                                <div class='row g-2' id='uploaded-photos'>
                                    {% for photo in form.instance.photos.all %}
                                    <div class='col-3 col-md-2'>
                                        <div class='position-relative'>
                                            <img src='{{ photo.thumbnail.url|default:photo.image.url }}'
                                                 alt='Фото {{ forloop.counter }}'
                                                 class='img-thumbnail w-100'
                                                 style='height: 80px; object-fit: cover;'>
                                            {% if photo.is_main %}
                                            <span class='badge bg-success position-absolute top-0 start-0 m-1'>Главное</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Описание -->
                        <div class='mb-4'>
                            {{ form.description|as_crispy_field }}
                        </div>

                        <!-- Кнопки -->
                        <div class='mt-4'>
                            <div class='d-flex justify-content-between'>
                                <a href='{% url "advertisements:my_ads" %}' class='btn btn-outline-secondary'>
                                    Отмена
                                </a>
                                <div>
                                    <button type='submit' name='save_draft' value='true' class='btn btn-outline-primary me-2'>
                                        Сохранить черновик
                                    </button>
                                    <button type='submit' name='publish' value='true' class='btn btn-primary'>
                                        {% if form.instance.pk %}
                                        <i class='fas fa-save me-2'></i>Сохранить изменения
                                        {% else %}
                                        <i class='fas fa-paper-plane me-2'></i>Опубликовать
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Подсказки -->
            <div class='mt-4'>
                <div class='alert alert-light'>
                    <h6 class='alert-heading'><i class='fas fa-lightbulb me-2'></i>Советы:</h6>
                    <ul class='mb-0'>
                        <li>Заполняйте все поля максимально подробно</li>
                        <li>Добавьте качественные фотографии с разных ракурсов</li>
                        <li>Укажите реальный пробег и состояние автомобиля</li>
                        <li>Укажите свой контактный телефон в профиле</li>
                        <li>Черновик можно сохранить и опубликовать позже</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/ru.js'></script>
<script src='{% static "js/dynamic-models.js" %}'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Инициализация страницы создания/редактирования объявления');

    // Получаем API URL из data-атрибута
    const apiUrls = document.getElementById('api-urls');
    const modelsApiUrl = apiUrls ? apiUrls.dataset.modelsApiUrl : '/advertisements/models-api/';
    console.log('Models API URL:', modelsApiUrl);

    // Инициализация Select2 для красивого выбора
    $('#id_brand, #id_fuel_type, #id_transmission_type, #id_drive_type, #id_condition, #id_steering_wheel, #id_mileage_unit').select2({
        theme: 'bootstrap-5',
        width: '100%',
        language: 'ru'
    });

    // Инициализация Select2 для поля модели с кастомным отображением
    $('#id_model').select2({
        theme: 'bootstrap-5',
        width: '100%',
        language: 'ru',
        templateResult: function(model) {
            if (!model.id) {
                return model.text;
            }
            // Показываем только имя модели без марки
            return model.text;
        },
        templateSelection: function(model) {
            if (!model.id) {
                return model.text;
            }
            // В выбранном поле тоже только имя модели
            return model.text;
        }
    });

    const brandSelect = document.getElementById('id_brand');
    const modelSelect = document.getElementById('id_model');
    const modelLoading = document.getElementById('model-loading');

    // Функция загрузки моделей
    function loadModels(brandId) {
        console.log('Загрузка моделей для марки ID:', brandId);

        if (!brandId) {
            console.log('Марка не выбрана, очищаем поле моделей');
            modelSelect.innerHTML = '<option value="">Сначала выберите марку</option>';
            modelSelect.disabled = true;
            $(modelSelect).trigger('change');
            return;
        }

        // Показываем индикатор загрузки
        modelLoading.style.display = 'block';
        modelSelect.disabled = true;
        modelSelect.innerHTML = '<option value="">Загрузка...</option>';
        $(modelSelect).trigger('change');

        // Используем правильный URL с brand_id параметром
        fetch(modelsApiUrl + '?brand_id=' + encodeURIComponent(brandId), {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => {
            console.log('Ответ от API:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error('Ошибка сети: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Получены данные моделей:', data);

            // Очищаем и заполняем select
            modelSelect.innerHTML = '<option value="">Выберите модель</option>';

            if (!data || data.length === 0) {
                console.log('Нет доступных моделей для выбранной марки');
                modelSelect.innerHTML += '<option value="" disabled>Нет доступных моделей</option>';
            } else {
                console.log(`Найдено ${data.length} моделей`);
                data.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    // Используем только имя модели без марки
                    option.textContent = model.name || model.full_name;

                    // Добавляем дополнительную информацию в data-атрибуты
                    option.dataset.yearStart = model.year_start || '';
                    option.dataset.yearEnd = model.year_end || '';
                    option.dataset.bodyType = model.body_type || '';
                    option.dataset.modelName = model.name || '';

                    modelSelect.appendChild(option);
                });
            }

            modelSelect.disabled = false;
            modelLoading.style.display = 'none';
            $(modelSelect).trigger('change');

            // Если есть сохраненная модель, выбираем ее
            {% if form.instance.model %}
                const savedModelId = {{ form.instance.model.id }};
                console.log('Сохраненная модель ID:', savedModelId);
                if (savedModelId) {
                    modelSelect.value = savedModelId;
                    $(modelSelect).trigger('change');
                }
            {% endif %}
        })
        .catch(error => {
            console.error('Ошибка загрузки моделей:', error);
            modelSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
            modelLoading.style.display = 'none';
            $(modelSelect).trigger('change');

            // Показываем сообщение об ошибке
            showError('Не удалось загрузить модели. Пожалуйста, попробуйте снова.');
        });
    }

    // Функция показа ошибки
    function showError(message) {
        console.log('Показ ошибки:', message);

        // Удаляем старые сообщения об ошибках
        const oldError = document.querySelector('.model-load-error');
        if (oldError) oldError.remove();

        // Создаем новое сообщение об ошибке
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show model-load-error mt-2';
        errorDiv.innerHTML = `
            <strong>Ошибка!</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        // Вставляем после контейнера выбора модели
        const container = document.getElementById('model-select-container');
        if (container) {
            container.appendChild(errorDiv);
        }
    }

    // Событие при изменении марки
    brandSelect.addEventListener('change', function() {
        console.log('Марка изменена:', this.value);
        loadModels(this.value);
    });

    // Событие при выборе модели (автозаполнение года и показ информации)
    modelSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        console.log('Модель выбрана:', selectedOption ? selectedOption.textContent : 'не выбрана');

        const yearStart = selectedOption.dataset.yearStart;
        const yearEnd = selectedOption.dataset.yearEnd;
        const bodyType = selectedOption.dataset.bodyType;

        // Автозаполнение года выпуска, если поле пустое
        const yearField = document.getElementById('id_year');
        if (yearField && !yearField.value && yearStart) {
            console.log('Автозаполнение года:', yearStart);
            yearField.value = yearStart;
        }

        // Показываем информацию о модели
        showModelInfo(yearStart, yearEnd, bodyType);
    });

    // Функция показа информации о модели
    function showModelInfo(yearStart, yearEnd, bodyType) {
        console.log('Показ информации о модели:', { yearStart, yearEnd, bodyType });

        // Удаляем старую информацию, если есть
        const oldInfo = document.getElementById('model-info');
        if (oldInfo) {
            oldInfo.remove();
        }

        // Получаем выбранную модель
        const modelSelect = document.getElementById('id_model');
        const selectedOption = modelSelect.options[modelSelect.selectedIndex];
        const modelName = selectedOption ? selectedOption.textContent : '';

        // Получаем выбранную марку
        const brandSelect = document.getElementById('id_brand');
        const selectedBrandOption = brandSelect.options[brandSelect.selectedIndex];
        const brandName = selectedBrandOption ? selectedBrandOption.textContent : '';

        // Создаем блок с информацией
        const infoDiv = document.createElement('div');
        infoDiv.id = 'model-info';
        infoDiv.className = 'alert alert-info mt-2';
        infoDiv.style.display = 'none';

        let infoText = '';
        const infoParts = [];

        if (brandName && modelName) {
            infoParts.push(`<strong>${brandName} ${modelName}</strong>`);
        }

        if (yearStart || yearEnd) {
            let yearText = 'производство ';
            if (yearStart) {
                yearText += `с ${yearStart} года`;
            }
            if (yearEnd) {
                yearText += yearStart ? ` по ${yearEnd} год` : `до ${yearEnd} года`;
            }
            infoParts.push(yearText);
        }

        if (bodyType) {
            infoParts.push(`тип кузова: ${bodyType}`);
        }

        if (infoParts.length > 0) {
            infoText = infoParts.join(', ');
            infoDiv.innerHTML = `<small><i class="fas fa-info-circle me-1"></i> ${infoText}</small>`;
            infoDiv.style.display = 'block';

            // Вставляем после контейнера выбора модели
            const container = document.getElementById('model-select-container');
            if (container) {
                container.appendChild(infoDiv);
            }
        }
    }

    // Если при загрузке страницы уже выбрана марка, загружаем модели
    {% if form.instance.model %}
        const initialBrandId = {{ form.instance.model.brand.id }};
        console.log('При загрузке выбрана марка ID:', initialBrandId);
        if (initialBrandId) {
            brandSelect.value = initialBrandId;
            loadModels(initialBrandId);
        }
    {% elif form.brand.value %}
        // Если форма была отправлена с ошибками
        const brandValueId = {{ form.brand.value.id|default:"null" }};
        console.log('Значение марки из формы:', brandValueId);
        if (brandValueId) {
            brandSelect.value = brandValueId;
            loadModels(brandValueId);
        }
    {% endif %}

    // Валидация формы
    document.getElementById('ad-form').addEventListener('submit', function(event) {
        const brandValue = brandSelect.value;
        const modelValue = modelSelect.value;

        console.log('Валидация формы:', { brandValue, modelValue });

        if (!brandValue || !modelValue) {
            event.preventDefault();
            const errorMsg = 'Пожалуйста, выберите марку и модель автомобиля';

            // Показываем ошибку
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger alert-dismissible fade show';
            errorDiv.innerHTML = `
                <strong>Ошибка!</strong> ${errorMsg}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // Вставляем перед формой
            this.parentNode.insertBefore(errorDiv, this);

            // Фокусируемся на первом пустом поле
            if (!brandValue) {
                brandSelect.focus();
            } else if (!modelValue) {
                modelSelect.focus();
            }
        }
    });

    // Ограничение на количество файлов
    const photoInput = document.getElementById('id_photos');
    if (photoInput) {
        photoInput.addEventListener('change', function() {
            const maxFiles = 20;
            const maxSize = 10 * 1024 * 1024; // 10MB
            const files = this.files;

            console.log('Выбрано файлов:', files.length);

            if (files.length > maxFiles) {
                alert(`Максимальное количество файлов: ${maxFiles}`);
                this.value = '';
                return;
            }

            // Проверка размера файлов
            for (let i = 0; i < files.length; i++) {
                if (files[i].size > maxSize) {
                    alert(`Файл "${files[i].name}" слишком большой. Максимальный размер: 10MB`);
                    this.value = '';
                    return;
                }
            }

            // Показать предпросмотр
            showImagePreview(files);
        });
    }

    // Показать предпросмотр изображений
    function showImagePreview(files) {
        console.log('Показ предпросмотра для файлов:', files.length);

        const previewContainer = document.getElementById('uploaded-photos') ||
                               (function() {
                                   const container = document.createElement('div');
                                   container.id = 'uploaded-photos';
                                   container.className = 'row g-2 mt-3';
                                   photoInput.parentNode.appendChild(container);
                                   return container;
                               })();

        // Очищаем только если это новые файлы (не при редактировании)
        if (!{% if form.instance.pk %}true{% else %}false{% endif %}) {
            previewContainer.innerHTML = '';
        }

        for (let i = 0; i < files.length; i++) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const col = document.createElement('div');
                col.className = 'col-3 col-md-2';
                col.innerHTML = `
                    <div class="position-relative">
                        <img src="${e.target.result}"
                             alt="Новое фото ${i+1}"
                             class="img-thumbnail w-100"
                             style="height: 80px; object-fit: cover;">
                        <span class="badge bg-primary position-absolute top-0 start-0 m-1">Новое</span>
                    </div>
                `;
                previewContainer.appendChild(col);
            };
            reader.readAsDataURL(files[i]);
        }
    }

    console.log('Инициализация завершена');
});
</script>
{% endblock %}